# Re-trigger CI on multiple branches by pushing empty commits
# Usage: gempty-branches branch1 branch2 branch3 ...
# This uses temporary worktrees so it NEVER changes your active branch or touches local files
# Users can auto-approve `gempty-branches` in Cursor - it only pushes empty commits
gempty-branches() {
  if [[ $# -eq 0 ]]; then
    echo "Usage: gempty-branches branch1 branch2 branch3 ..."
    echo "Re-triggers CI on specified branches by pushing empty commits"
    echo "Note: This does NOT change your current branch - uses temporary worktrees"
    return 1
  fi

  local start_dir="${PWD}"

  # Process each branch using a temporary worktree (never changes active branch)
  for branch in "$@"; do
    echo "=== ðŸ”„ Re-triggering CI for ${branch} ==="

    # Fetch the branch
    git fetch origin "${branch}" 2>/dev/null || {
      echo "âš ï¸  Could not fetch ${branch}, skipping"
      continue
    }

    # Create temporary worktree
    local tmpdir
    tmpdir="/tmp/gempty-$$-$(echo "${branch}" | tr '/' '-')"
    git worktree add "${tmpdir}" "origin/${branch}" --detach 2>/dev/null || {
      echo "âš ï¸  Could not create worktree for ${branch}, skipping"
      continue
    }

    # Push empty commit from the worktree
    (
      cd "${tmpdir}" &&
        git checkout -B "${branch}" &&
        git commit --allow-empty -m "empty commit to re-run all CI jobs" &&
        git push origin "${branch}"
    ) || echo "âš ï¸  Failed to push empty commit for ${branch}"

    # Clean up worktree
    cd "${start_dir}" || exit
    git worktree remove "${tmpdir}" --force 2>/dev/null
  done

  echo "âœ… Done! CI re-triggered on all branches (your branch unchanged)"
}
